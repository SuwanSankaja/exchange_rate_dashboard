<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confinix Exchange Rate Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for creating interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- dayjs for easier date manipulation -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Confinix SL Rates</h1>
            <p class="text-gray-400 mt-2">Live Exchange rates for Intenational Currencies in Sri Lanka</p>
        </header>

        <!-- Loading and Error State Containers -->
        <div id="loading-state" class="text-center py-10">
            <div id="loader" class="w-12 h-12 rounded-full border-4 border-gray-700 mx-auto"></div>
            <p class="mt-4 text-gray-400">Loading Live Exchange Rate Data...</p>
        </div>
        <div id="error-state" class="hidden text-center bg-red-900/50 border border-red-500/50 text-red-300 p-6 rounded-lg">
            <h2 class="font-semibold text-lg">Failed to Load Data</h2>
            <p id="error-message" class="mt-2">Could not connect to the backend server.</p>
        </div>

        <!-- Dashboard Content (hidden by default, shown on successful data load) -->
        <div id="dashboard-content" class="hidden">
            <!-- Today's Best Rates Section -->
            <section id="today-rates" class="mb-8">
                <h2 class="text-2xl font-semibold text-white mb-4">Today's Best Rates</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-green-500/50 flex flex-col">
                        <h3 class="font-semibold text-lg text-green-400">Best Selling Rate (Your Perspective)</h3>
                        <p class="text-gray-400 text-sm mb-3">The highest rate a bank will buy AUD from you.</p>
                        <p id="best-selling-rate" class="text-4xl font-bold text-white mt-auto">-</p>
                        <p id="best-selling-bank" class="text-green-400 mt-1">-</p>
                        <p id="avg-selling-rate" class="text-lg text-gray-400 mt-2">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6 shadow-lg border border-blue-500/50 flex flex-col">
                        <h3 class="font-semibold text-lg text-blue-400">Best Buying Rate (Your Perspective)</h3>
                        <p class="text-gray-400 text-sm mb-3">The lowest rate a bank will sell AUD to you.</p>
                        <p id="best-buying-rate" class="text-4xl font-bold text-white mt-auto">-</p>
                        <p id="best-buying-bank" class="text-blue-400 mt-1">-</p>
                        <p id="avg-buying-rate" class="text-lg text-gray-400 mt-2">-</p>
                    </div>
                </div>
                <p id="last-updated" class="text-center text-sm text-gray-500 mt-4"></p>
            </section>

            <!-- Historical Data Chart Section -->
            <section class="bg-gray-800 rounded-lg p-4 md:p-6 shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4">Historical Rate Analysis (Bank Perspective)</h2>
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <div id="rate-type-selector" class="flex bg-gray-700 rounded-lg p-1">
                        <button data-rate-type="buying_rate" class="rate-type-btn bg-gray-900 text-white py-2 px-4 rounded-md text-sm font-medium">Buying Rate</button>
                        <button data-rate-type="selling_rate" class="rate-type-btn text-gray-300 py-2 px-4 rounded-md text-sm font-medium">Selling Rate</button>
                    </div>
                    <div id="time-range-selector" class="flex flex-wrap gap-2">
                        <button data-range="7d" class="time-range-btn bg-blue-600 py-1 px-3 rounded text-xs">7D</button>
                        <button data-range="1m" class="time-range-btn bg-gray-700 hover:bg-gray-600 py-1 px-3 rounded text-xs">1M</button>
                        <button data-range="3m" class="time-range-btn bg-gray-700 hover:bg-gray-600 py-1 px-3 rounded text-xs">3M</button>
                        <button data-range="6m" class="time-range-btn bg-gray-700 hover:bg-gray-600 py-1 px-3 rounded text-xs">6M</button>
                        <button data-range="1y" class="time-range-btn bg-gray-700 hover:bg-gray-600 py-1 px-3 rounded text-xs">1Y</button>
                        <button data-range="all" class="time-range-btn bg-gray-700 hover:bg-gray-600 py-1 px-3 rounded text-xs">All</button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-md font-semibold mb-2">Select Banks:</h3>
                    <div id="bank-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 text-sm"></div>
                </div>
                <div>
                    <canvas id="rateChart"></canvas>
                </div>
            </section>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let chart;
        let originalData = [];
        let selectedRateType = 'buying_rate';
        let selectedTimeRange = '7d'; // Default time range set to 7 days
        let selectedBanks = [];
        const allBankNames = new Set();
        const chartColors = ['#34d399', '#60a5fa', '#f87171', '#fbbf24', '#a78bfa', '#f472b6', '#4ade80', '#2dd4bf', '#818cf8', '#fb923c'];
        const API_URL = 'http://localhost:3000/api/rates';

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', fetchDataAndInitializeDashboard);

        // --- DATA FETCHING AND SETUP ---
        async function fetchDataAndInitializeDashboard() {
            const loadingEl = document.getElementById('loading-state');
            const errorEl = document.getElementById('error-state');
            const errorMessageEl = document.getElementById('error-message');
            const dashboardEl = document.getElementById('dashboard-content');
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}: ${errorText}`);
                }
                const rawData = await response.json();
                
                if (!rawData || rawData.length === 0) {
                    throw new Error("No data was received from the server. The collection might be empty.");
                }

                originalData = rawData.map(d => ({
                    ...d,
                    date: dayjs(d.date).format('YYYY-MM-DD')
                })).sort((a, b) => dayjs(a.date).valueOf() - dayjs(b.date).valueOf());

                originalData.forEach(d => {
                    if (d.bank_rates) {
                        Object.keys(d.bank_rates).forEach(bank => allBankNames.add(bank));
                    }
                });

                initializeUI();
                
                loadingEl.classList.add('hidden');
                dashboardEl.classList.remove('hidden');

            } catch (error) {
                console.error("Dashboard initialization failed:", error);
                errorMessageEl.textContent = `Could not load data. Please ensure the backend server is running and accessible at ${API_URL}. Details: ${error.message}`;
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }
        
        function initializeUI() {
            setupBankSelector();
            displayBestRates();
            setupControls();
            createOrUpdateChart();
        }

        // --- UI FUNCTIONS ---
        function displayBestRates() {
            const latestData = originalData[originalData.length - 1];
            if (!latestData || !latestData.market_statistics) {
                 console.error("Could not find 'market_statistics' in the latest data entry.");
                 return;
            };

            const { people_selling, people_buying } = latestData.market_statistics;
            const lastUpdatedDate = dayjs(latestData.last_updated?.$date || latestData.date);

            const bestSellingRate = people_selling?.max?.toFixed(2);
            document.getElementById('best-selling-rate').textContent = bestSellingRate ? `LKR ${bestSellingRate}` : 'N/A';
            document.getElementById('best-selling-bank').textContent = people_selling?.best_bank ? `at ${people_selling.best_bank}` : '';
            
            const avgSellingRate = people_selling?.avg?.toFixed(2);
            document.getElementById('avg-selling-rate').textContent = avgSellingRate ? `Avg Selling Rate: LKR ${avgSellingRate}` : '';


            const bestBuyingRate = people_buying?.min?.toFixed(2);
            document.getElementById('best-buying-rate').textContent = bestBuyingRate ? `LKR ${bestBuyingRate}` : 'N/A';
            document.getElementById('best-buying-bank').textContent = people_buying?.best_bank ? `at ${people_buying.best_bank}` : '';

            const avgBuyingRate = people_buying?.avg?.toFixed(2);
            document.getElementById('avg-buying-rate').textContent = avgBuyingRate ? `Avg Buying Rate: LKR ${avgBuyingRate}` : '';
            
            document.getElementById('last-updated').textContent = `Last updated: ${lastUpdatedDate.format('YYYY-MM-DD HH:mm')}`;
        }
        
        function setupBankSelector() {
            const container = document.getElementById('bank-selector');
            container.innerHTML = '';
            // Default to selecting specific banks
            selectedBanks = ["Hatton National Bank", "Nations Trust Bank", "Bank of Ceylon","Commercial Bank"]; 
            Array.from(allBankNames).sort().forEach((bank, index) => {
                const isChecked = selectedBanks.includes(bank);
                const color = chartColors[index % chartColors.length];
                container.innerHTML += `
                    <div class="flex items-center">
                        <input type="checkbox" id="bank-${index}" value="${bank}" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-600" style="accent-color: ${color};">
                        <label for="bank-${index}" class="ml-2 text-gray-300 cursor-pointer">${bank}</label>
                    </div>
                `;
            });
        }
        
        function setupControls() {
            document.getElementById('rate-type-selector').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    selectedRateType = e.target.dataset.rateType;
                    document.querySelectorAll('.rate-type-btn').forEach(btn => {
                        btn.classList.remove('bg-gray-900', 'text-white');
                        btn.classList.add('text-gray-300');
                    });
                    e.target.classList.add('bg-gray-900', 'text-white');
                    createOrUpdateChart();
                }
            });

            document.getElementById('time-range-selector').addEventListener('click', (e) => {
                 if (e.target.tagName === 'BUTTON') {
                    selectedTimeRange = e.target.dataset.range;
                    document.querySelectorAll('.time-range-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    });
                    e.target.classList.add('bg-blue-600');
                    e.target.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    createOrUpdateChart();
                }
            });

            document.getElementById('bank-selector').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    selectedBanks = Array.from(document.querySelectorAll('#bank-selector input:checked')).map(cb => cb.value);
                    createOrUpdateChart();
                }
            });
        }

        // --- CHART LOGIC ---
        function filterDataByTimeRange(data) {
            if (selectedTimeRange === 'all') return data;
            const now = dayjs();
            let startDate;
            switch (selectedTimeRange) {
                case '7d': startDate = now.subtract(7, 'day'); break;
                case '1m': startDate = now.subtract(1, 'month'); break;
                case '3m': startDate = now.subtract(3, 'month'); break;
                case '6m': startDate = now.subtract(6, 'month'); break;
                case '1y': startDate = now.subtract(1, 'year'); break;
                default: return data;
            }
            return data.filter(d => dayjs(d.date).isAfter(startDate));
        }

        function prepareChartData() {
            const filteredData = filterDataByTimeRange(originalData);
            const labels = filteredData.map(d => d.date);
            const sortedBankNames = Array.from(allBankNames).sort();
            const datasets = selectedBanks.map(bankName => {
                const bankIndex = sortedBankNames.indexOf(bankName);
                const color = chartColors[bankIndex % chartColors.length];
                const dataPoints = filteredData.map(dayData => dayData.bank_rates?.[bankName]?.[selectedRateType] || null);
                return {
                    label: bankName, data: dataPoints, borderColor: color, backgroundColor: `${color}33`,
                    fill: false, tension: 0.2, borderWidth: 2, pointRadius: 1.5, pointHoverRadius: 5
                };
            });
            return { labels, datasets };
        }

        function createOrUpdateChart() {
            if (!originalData.length) return;
            const { labels, datasets } = prepareChartData();
            const options = {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                    y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' }, title: { display: true, text: 'Rate (LKR)', color: '#d1d5db' } }
                },
                plugins: {
                    legend: { position: 'top', labels: { color: '#d1d5db', usePointStyle: true, boxWidth: 8 } },
                    tooltip: { mode: 'index', intersect: false, backgroundColor: '#1f2937', titleColor: '#ffffff', bodyColor: '#d1d5db', borderColor: '#4b5563', borderWidth: 1 }
                },
                interaction: { mode: 'index', intersect: false },
            };
            const ctx = document.getElementById('rateChart').getContext('2d');
            if (chart) {
                chart.data.labels = labels;
                chart.data.datasets = datasets;
                chart.update();
            } else {
                chart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: options });
            }
        }
    </script>
</body>
</html>
